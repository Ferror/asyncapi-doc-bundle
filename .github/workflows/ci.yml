name: CI

on:
  push: ~
  pull_request: ~
  workflow_dispatch: ~

jobs:
  tests:
    runs-on: ubuntu-latest
    name: CI - PHP ${{ matrix.php }}, Dependencies ${{ matrix.dependencies }}
    strategy:
      matrix:
        php: [8.2, 8.3]
        dependencies: [lowest, highest]
        include:
          -
            php: 8.2
            dependencies: lowest
            coveralls: true

    steps:
      - # Copies the repository files to the Action Runner
        name: Checkout Repository
        uses: actions/checkout@v3

      - # Installs PHP and other necessary tools
        name: Setup PHP
        uses: shivammathur/setup-php@2.25.4
        with:
          php-version: ${{ matrix.php }}

      - # Installs and caches PHP dependencies 
        name: Install Dependencies
        uses: ramsey/composer-install@2.2.0
        with:
          dependency-versions: ${{ matrix.dependencies }}

      - # Validates composer.json structure and required fields
        name: Validate composer.json
        run: composer validate --ansi --strict --no-check-publish

      - # Runs code quality tools, like phpstan etc.
        name: Run Code Quality Tools
        if: false
        run: composer analyse

      - # Runs unit and integration tests, like phpspec, phpunit etc.
        name: Run Tests
        run: composer coverage

      -
        name: Async API Validation 1
        if: true
        run: |
          npm install -g @asyncapi/cli@0.54.3
          asyncapi validate var/asyncapi.yaml | grep error && exit 1
          asyncapi validate tmp/asyncapi.yaml | grep error && exit 1

      -
        name: Coveralls
        if: ${{ matrix.coveralls }}
        uses: coverallsapp/github-action@v2.2.3
        with:
          file: var/coverage/clover.xml
